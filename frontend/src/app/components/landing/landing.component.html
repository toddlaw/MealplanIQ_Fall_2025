<div class="form-container mat-elevation-z5 text-center" #start>
  <div class="text-container">
    <h1 class="beta">
      MealPlanIQ is currently in beta and we are working to make it better! We
      appreciate your patience.
    </h1>
    <h1 class="header">
      Fighting cancer, heart disease, or diabetes? Want to lose weight or gain
      muscle?
    </h1>
    <p class="sub-text">
      <i>MealPlan IQ</i> combines a registered dietician's advice with your
      preferences and restrictions to generate
      <strong><i>personalized</i> and <i>optimized</i> meal plans</strong> that
      meet government-recommended nutritional requirements.
    </p>
    <p class="sub-header">Give it a try!</p>
    <p class="sub-header">
      ① Select your health goal:
    </p>
  </div>
  <div class="content">
    <form #peopleForm="ngForm" (ngSubmit)="showTermsAndConditions()">
      <div class="row">
        <div class="example-button-container">
          <button
            *ngFor="let item of healthGoals; let i = index"
            type="button"
            mat-fab
            class="health-goal-btn"
            color="primary"
            [class.selected-btn]="selectedHealthGoalIndex === i"
            (click)="healthGoalChange(i, item.value)"
          >
            <span>
              {{ item.viewValue1 }}
              <br class="br-btn" />
              {{ item.viewValue2 }}
              <br class="br-btn" />
              {{ item.viewValue3 != "" ? " " + item.viewValue3 : null }}
              <!-- {{ item.viewValue3 }} -->
            </span>
          </button>
        </div>
      </div>
      <p class="sub-header">
        ② Personalize your diet
      </p>
      <div class="row">
        <mat-accordion class="mat-accordian" multi>
          <mat-expansion-panel #peoplePanel [expanded]="panelOpenState">
            <mat-expansion-panel-header>
              <mat-panel-title>
                People
                <mat-icon
                  class="icon-display"
                  svgIcon="people"
                  style="padding-left: 10px"
                ></mat-icon>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <div class="sub-container">
              <div class="add-people-icons">
                <button
                  [style.visibility]="
                    people.length > MIN_PEOPLE ? 'visible' : 'hidden'
                  "
                  mat-icon-button
                  type="button"
                  (click)="changeFields(-1)"
                >
                  <mat-icon class="icon-display red-icon">remove</mat-icon>
                </button>
                <span class="person-number" style="width: 20px">{{
                  people.length
                }}</span>
                <button
                  [style.visibility]="
                    people.length < MAX_PEOPLE ? 'visible' : 'hidden'
                  "
                  mat-icon-button
                  type="button"
                  (click)="changeFields(1)"
                >
                  <mat-icon class="icon-display green-icon">add</mat-icon>
                </button>
              </div>
              <div>
                <mat-button-toggle-group>
                  <mat-button-toggle
                    value=""
                    (click)="setSelectedUnit('metric')"
                    checked
                    >Metric</mat-button-toggle
                  >
                  <mat-button-toggle
                    value=""
                    (click)="setSelectedUnit('imperial')"
                    >Imperial</mat-button-toggle
                  >
                </mat-button-toggle-group>
              </div>
            </div>
            <ng-container *ngFor="let person of people; let i = index" class="">
              <div class="row no-wrap">
                <mat-form-field class="age">
                  <input
                    matInput
                    type="number"
                    placeholder="Age"
                    [(ngModel)]="person.age"
                    min="1"
                    [name]="'age' + i"
                    required
                  />
                </mat-form-field>

                <mat-form-field class="gender">
                  <mat-label>Gender</mat-label>
                  <mat-select
                    required
                    [(ngModel)]="person.gender"
                    [name]="'gender' + i"
                  >
                    <mat-option
                      *ngFor="let gender of genders"
                      [value]="gender.value"
                    >
                      {{ gender.viewValue }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field class="weight">
                  <input
                    matInput
                    type="number"
                    [placeholder]="
                      selectedUnit === 'metric'
                        ? 'Weight' + ' (KG)'
                        : 'Weight ' + ' (LBS)'
                    "
                    [(ngModel)]="person.weight"
                    [name]="'weight' + i"
                    min="0"
                    required
                  />
                </mat-form-field>

                <mat-form-field class="height">
                  <input
                    matInput
                    type="number"
                    [placeholder]="
                      selectedUnit === 'metric'
                        ? 'Height' + ' (CM)'
                        : 'Height' + ' (IN)'
                    "
                    [(ngModel)]="person.height"
                    [name]="'height' + i"
                    min="0"
                    required
                  />
                </mat-form-field>

                <mat-form-field class="activity-level">
                  <mat-label>Activity Level</mat-label>
                  <mat-select
                    required
                    [(ngModel)]="person.activityLevel"
                    [name]="'activityLevel' + i"
                  >
                    <mat-option
                      *ngFor="let activityLevel of activityLevels"
                      [value]="activityLevel.value"
                    >
                      {{ activityLevel.viewValue }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>
            </ng-container>
            <button
              mat-button
              color="primary"
              type="button"
              (click)="closePanel()"
            >
              Done
            </button>
          </mat-expansion-panel>
        </mat-accordion>
      </div>
      <div>
        <div class="row">
          <mat-form-field class="dietary-constraints">
            <mat-label>Dietary Constraints</mat-label>
            <mat-select
              required
              [(ngModel)]="selectedDietaryConstraint"
              name="dietaryConstraint"
            >
              <mat-option
                *ngFor="let vegetarian of vegetarians"
                [value]="vegetarian.value"
              >
                {{ vegetarian.viewValue }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field class="religious-constraints">
            <mat-label>Religious Constraints</mat-label>
            <mat-select
              required
              [(ngModel)]="selectedReligiousConstraint"
              name="religiousConstraint"
            >
              <mat-option
                *ngFor="let Religious of religiousConstraints"
                [value]="Religious.value"
              >
                {{ Religious.viewValue }}
              </mat-option>
            </mat-select>
            <mat-icon svgIcon="religious" class="mat-icon-right">icon</mat-icon>
          </mat-form-field>

          <mat-form-field class="liked-foods">
            <mat-label>Liked Foods</mat-label>
            <mat-select [formControl]="likedFoods" multiple name="likedFoods">
              <mat-select-trigger>
                {{likedFoods.value?.[0] || ''}}
                <span *ngIf="(likedFoods.value?.length || 0) > 1">
                  (+{{ (likedFoods.value?.length || 0) - 1 }}
                  {{ likedFoods.value?.length === 2 ? "other" : "others" }})
                </span>
              </mat-select-trigger>
              <mat-option
                *ngFor="let likedFood of likedFoodsList"
                [value]="likedFood"
              >
                {{ likedFood }}
              </mat-option>
            </mat-select>
            <mat-icon svgIcon="liked-foods" class="mat-icon-right"
              >icon</mat-icon
            >
          </mat-form-field>

          <mat-form-field class="favourite-cuisines">
            <mat-label>Disliked Foods</mat-label>
            <mat-select [formControl]="dislikedFoods" multiple>
              <mat-select-trigger>
                {{dislikedFoods.value?.[0] || ''}}
                <span *ngIf="(dislikedFoods.value?.length || 0) > 1">
                  (+{{ (dislikedFoods.value?.length || 0) - 1 }}
                  {{ dislikedFoods.value?.length === 2 ? "other" : "others" }})
                </span>
              </mat-select-trigger>
              <mat-option
                *ngFor="let dislikedFoods of dislikedFoodsList"
                [value]="dislikedFoods"
                >{{ dislikedFoods }}</mat-option
              >
            </mat-select>
            <mat-icon svgIcon="disliked-foods" class="mat-icon-right"
              >icon</mat-icon
            >
          </mat-form-field>
        </div>
        <div class="row">
          <mat-form-field class="favourite-cuisines">
            <mat-label>Favourite Cuisines</mat-label>
            <mat-select [formControl]="cuisines" multiple>
              <mat-select-trigger>
                {{cuisines.value?.[0] || ''}}
                <span *ngIf="(cuisines.value?.length || 0) > 1">
                  (+{{ (cuisines.value?.length || 0) - 1 }}
                  {{ cuisines.value?.length === 2 ? "other" : "others" }})
                </span>
              </mat-select-trigger>
              <mat-option
                *ngFor="let cuisine of cuisinesList"
                [value]="cuisine"
                >{{ cuisine }}</mat-option
              >
            </mat-select>
          </mat-form-field>
          <mat-form-field>
            <mat-label>Allergies</mat-label>
            <mat-select [formControl]="allergies" multiple>
              <mat-select-trigger>
                {{ allergies.value?.[0] || ''}}
                <span *ngIf="(allergies.value?.length || 0) > 1">
                  (+{{ (allergies.value?.length || 0) - 1 }}
                  {{ allergies.value?.length === 2 ? "other" : "others" }})
                </span>
              </mat-select-trigger>
              <mat-option
                *ngFor="let allergy of allergiesList"
                [value]="allergy"
              >
                {{ allergy }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field class="">
            <mat-label>Meal plan range</mat-label>
            <mat-date-range-input
              [formGroup]="startDate"
              [rangePicker]="mealPlanRange"
            >
              <input
                matStartDate
                placeholder="Start date"
                formControlName="start"
                readonly
              />
              <input
                matEndDate
                placeholder="End date"
                formControlName="end"
                readonly
              />
            </mat-date-range-input>
            <mat-datepicker-toggle
              matIconSuffix
              [for]="mealPlanRange"
            ></mat-datepicker-toggle>
            <mat-date-range-picker #mealPlanRange></mat-date-range-picker>
          </mat-form-field>
        </div>

        <div class="submit-button-container">
          <p class="sub-header">③ Generate your meal plan!</p>
          <button mat-raised-button color="primary" type="submit">
            <mat-icon>search</mat-icon>
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<br />

<!-- start of response ui -->
<div #scrollToMe hidden>
  <div class="loading-meal-plan">
    <h1 class="centered-text text-xl">Generating your meal plan...</h1>
    <div class="spinner-container">
      <mat-spinner></mat-spinner>
    </div>
  </div>
</div>
<div #errorDiv hidden>
  <div class="loading-meal-plan">
    <h1 class="centered-text text-xl">
      Sorry, there was an error generating your meal plan
    </h1>
    <h2 class="centered-text text-xl link"><a (click)="this.scrollToTop()">Please try again</a></h2>
  </div>
</div>
<div class="container" *ngIf="!this.isEmpty(mealPlanResponse)">
  <h2 class="sub-header" *ngIf="searchClicked">
    ④ Want to change this plan? Select the meals you don't like and search again.
  </h2>

  <div *ngIf="mealPlanResponse.constraints_loosened">
    <p class="change-recipe-text" style="font-style: italic">
      {{ OUT_OF_RANGE }}
    </p>
    <br />
  </div>

  <button
    mat-raised-button
    color="primary"
    class="get-full-meal-plan-button"
    (click)="getFullMealPlan()"
  >
    Get full meal plan
  </button>
  <div
    *ngFor="let day of mealPlanResponse.days; index as i"
    class="recipe-day"
    [ngClass]="{ 'no-top-margin': i === 0 }"
  >
    <h2>{{ day.date }}</h2>
    <div
      *ngFor="let recipe of day.recipes; index as j"
      class="recipe-container"
    >
      <div class="recipe-row">
        <div class="meal-type">
          <h3 style="font-size: 18px; margin-bottom: 0px">
            {{ mealNames[j] }}
          </h3>
        </div>
        <mat-card class="recipe-card" (click)="toggleExpand(i, j)">
          <div class="recipe-card-flex">
            <img
              [src]="getImageUrl(recipe.id)"
              class="recipe-card-image"
              height="50"
              width="50"
              alt="Image"
            />
            <mat-card-title
              style="margin: 0px; text-align: center; line-height: 25px;"
              >{{ recipe.title }}</mat-card-title
            >
            <img
              src="../../../assets/images/{{
                expandedStates[i][j] ? 'chevron-up.png' : 'chevron-down.png'
              }}"
              height="25"
              width="25"
              alt="Image"
            />
          </div>
          <div *ngIf="expandedStates[i][j]" class="recipe-card-info">
            <div>
              <p>Energy: {{ this.floor(recipe.calories) }} calories</p>
              <p>Cuisine: {{ recipe.region }}</p>
              <p>Prep time: {{ recipe.prep_time }}</p>
              <!-- <p>Estimated Price: ${{ recipe.price }}</p> -->
            </div>
            <div class="replace-meal-container">
              <mat-form-field>
                <mat-select
                  [(value)]="selectedOptions[i][j]"
                  (selectionChange)="
                    onReplaceMealChange($event, recipe.id, i, j)
                  "
                  (click)="$event.stopPropagation()"
                >
                  <mat-option selected value="keep">Keep meal</mat-option>
                  <mat-option value="replace">Replace meal</mat-option>
                </mat-select>
              </mat-form-field>
            </div>
          </div>
        </mat-card>
      </div>
    </div>
  </div>
  <div *ngIf="mealPlanResponse.snacks.length > 0">
    <h2 class="text-center text-l">Side dishes</h2>
    <div class="snack-container">
      <div *ngFor="let snack of mealPlanResponse.snacks; index as i">
        <mat-card class="recipe-card" (click)="toggleSnackExpand(i)">
          <div class="recipe-card-flex">
            <img
              [src]="getImageUrl(snack.id)"
              height="50"
              width="50"
              alt="Image"
            />
            <mat-card-title style="margin: 0px; text-align: center; line-height: 25px;">{{
              snack.title
            }}</mat-card-title>
            <img
              src="../../../assets/images/{{
                snackExpandedStates[i] ? 'chevron-up.png' : 'chevron-down.png'
              }}"
              height="25"
              width="25"
              alt="Image"
            />
          </div>
          <div *ngIf="snackExpandedStates[i]" class="recipe-card-info">
            <div>
              <p>Energy: {{ this.floor(snack.calories) }} calories</p>
              <p>Cuisine: {{ snack.region }}</p>
              <p>Prep time: {{ snack.prep_time }}</p>
              <p>Multiples: {{ snack.multiples }}</p>
            </div>
          </div>
        </mat-card>
      </div>
    </div>
  </div>
  <br />
  <br />
  <div>
    <table mat-table [dataSource]="mealPlanResponse.tableData">
      <ng-container matColumnDef="nutrientName">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let element">
          <!-- Turn "Vitamin a" "Vitamin A" -->
          {{
            element.nutrientName.includes("vitamin")
              ? this.displayVitamin(element.nutrientName)
              : element.nutrientName.charAt(0).toUpperCase() +
                element.nutrientName.slice(1)
          }}
        </td>
      </ng-container>

      <ng-container matColumnDef="target">
        <th mat-header-cell *matHeaderCellDef>Target</th>
        <td mat-cell *matCellDef="let element">{{ element.target }}</td>
      </ng-container>

      <ng-container matColumnDef="actual">
        <th mat-header-cell *matHeaderCellDef>Your Meal Plan</th>
        <td mat-cell *matCellDef="let element">{{ element.actual }}</td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
</div>
